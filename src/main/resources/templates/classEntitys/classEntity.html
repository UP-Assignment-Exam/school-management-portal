<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/style.css}"/>
    <style>
        .table-responsive {
            border-radius: 0.375rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .btn-action {
            padding: 0.25rem 0.5rem;
            margin: 0 0.125rem;
        }
        .status-badge {
            font-size: 0.75rem;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .form-floating > label {
            padding: 1rem 0.75rem;
        }
        .search-container {
            position: relative;
        }
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        .search-input {
            padding-left: 45px;
        }
    </style>
</head>
<body class="bg-light">
<!-- Sidebar -->
<div th:replace="fragments/sidebar :: sidebar"></div>

<!-- Main Content -->
<div class="main-content" id="main-content">
    <!-- Top Header -->
    <div th:replace="fragments/header :: header"></div>

    <!-- Content Area -->
    <div class="content-area">


        <div class="container-fluid py-4">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col">
                    <h1 class="h3 mb-3">
                        <i class="fas fa-chalkboard-teacher text-primary me-2"></i>
                        Class Management
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" class="text-decoration-none">Dashboard</a></li>
                            <li class="breadcrumb-item active">Classes</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <!-- Controls -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-1">Available Spots</h5>
                                    <h3 class="mb-0" id="availableSpotsCount">-</h3>
                                </div>
                                <i class="fas fa-users fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Classes Table -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Classes List
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="classesTable">
                            <thead class="table-light">
                            <tr>
                                <th>Class Name</th>
                                <th>Description</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Teacher</th>
                                <th>Students</th>
                                <th>Max Students</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="classesTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0 text-muted">Loading classes...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Class Modal (Add/Edit) -->
<div class="modal fade" id="classModal" tabindex="-1" aria-labelledby="classModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="classModalLabel">
                    <i class="fas fa-chalkboard-teacher me-2"></i>
                    <span id="modalTitle">Add New Class</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="classForm">
                <div class="modal-body">
                    <input type="hidden" id="classId" name="id">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="className" name="name"
                                       placeholder="Class Name" required maxlength="100">
                                <label for="className">Class Name *</label>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="number" class="form-control" id="maxStudents" name="maxStudents"
                                       placeholder="Maximum Students" min="1" max="1000">
                                <label for="maxStudents">Maximum Students</label>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating mb-3">
                            <textarea class="form-control" id="classDescription" name="description"
                                      placeholder="Description" style="height: 100px" maxlength="500"></textarea>
                        <label for="classDescription">Description</label>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="date" class="form-control" id="startDate" name="startDate"
                                       placeholder="Start Date" required>
                                <label for="startDate">Start Date *</label>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="date" class="form-control" id="endDate" name="endDate"
                                       placeholder="End Date" required>
                                <label for="endDate">End Date *</label>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating mb-3">
                        <select class="form-select" id="teacherId" name="teacherId">
                            <option value="">Select Teacher</option>
                            <!-- Teachers will be loaded dynamically -->
                        </select>
                        <label for="teacherId">Teacher</label>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        Fields marked with * are required.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveClassBtn">
                        <i class="fas fa-save me-1"></i> Save Class
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this class?</p>
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Class:</strong> <span id="deleteClassName">-</span><br>
                    <small>This action cannot be undone, but the class will be soft-deleted and can be recovered by
                        administrators.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i> Delete Class
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer">
    <!-- Toasts will be added here dynamically -->
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
    // Global variables
    let currentEditingId = null;
    let deleteClassId = null;

    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const refreshBtn = document.getElementById('refreshBtn');
    const addClassBtn = document.getElementById('addClassBtn');
    const classForm = document.getElementById('classForm');
    const classModal = new bootstrap.Modal(document.getElementById('classModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const classesTableBody = document.getElementById('classesTableBody');
    const modalTitle = document.getElementById('modalTitle');
    const saveClassBtn = document.getElementById('saveClassBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadClasses();
        loadStatistics();
        setupEventListeners();
    });

    // Event Listeners
    function setupEventListeners() {
        // Search functionality
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadClasses(this.value);
            }, 300);
        });

        // Refresh button
        refreshBtn.addEventListener('click', function() {
            loadClasses();
            loadStatistics();
        });

        // Add class button
        addClassBtn.addEventListener('click', function() {
            resetForm();
            currentEditingId = null;
            modalTitle.textContent = 'Add New Class';
            saveClassBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save Class';
        });

        // Form submission
        classForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveClass();
        });

        // Delete confirmation
        confirmDeleteBtn.addEventListener('click', function() {
            if (deleteClassId) {
                deleteClass(deleteClassId);
            }
        });

        // Date validation
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        startDateInput.addEventListener('change', function() {
            if (endDateInput.value && this.value > endDateInput.value) {
                endDateInput.value = this.value;
            }
            endDateInput.min = this.value;
        });

        endDateInput.addEventListener('change', function() {
            if (startDateInput.value && this.value < startDateInput.value) {
                startDateInput.value = this.value;
            }
            startDateInput.max = this.value;
        });
    }

    // API Functions
    async function loadClasses(search = '') {
        try {
            showLoading(true);
            const url = search ? `/api/classes?search=${encodeURIComponent(search)}` : '/api/classes';
            const response = await fetch(url);
            const data = await response.json();

            if (response.ok) {
                renderClassesTable(data.classes || []);
            } else {
                showToast('Error loading classes: ' + (data.message || 'Unknown error'), 'error');
                renderClassesTable([]);
            }
        } catch (error) {
            console.error('Error loading classes:', error);
            showToast('Failed to load classes. Please try again.', 'error');
            renderClassesTable([]);
        } finally {
            showLoading(false);
        }
    }

    async function loadStatistics() {
        try {
            const response = await fetch('/api/classes/stats');
            const data = await response.json();

            if (response.ok && data.stats) {
                document.getElementById('totalClassesCount').textContent = data.stats.totalActiveClasses || 0;
                document.getElementById('availableSpotsCount').textContent = data.stats.classesWithAvailableSpots || 0;
            }
        } catch (error) {
            console.error('Error loading statistics:', error);
        }
    }

    async function saveClass() {
        try {
            // Validate form
            if (!validateForm()) {
                return;
            }

            showButtonLoading(saveClassBtn, true);

            const formData = new FormData(classForm);
            const classData = {
                name: formData.get('name'),
                description: formData.get('description'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                maxStudents: formData.get('maxStudents') ? parseInt(formData.get('maxStudents')) : null,
                teacher: formData.get('teacherId') ? { id: parseInt(formData.get('teacherId')) } : null
            };

            const url = currentEditingId ? `/api/classes/${currentEditingId}` : '/api/classes';
            const method = currentEditingId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(classData)
            });

            const data = await response.json();

            if (response.ok) {
                showToast(data.message || 'Class saved successfully!', 'success');
                classModal.hide();
                loadClasses();
                loadStatistics();
            } else {
                showToast('Error: ' + (data.message || 'Failed to save class'), 'error');
            }
        } catch (error) {
            console.error('Error saving class:', error);
            showToast('Failed to save class. Please try again.', 'error');
        } finally {
            showButtonLoading(saveClassBtn, false);
        }
    }

    async function deleteClass(id) {
        try {
            showButtonLoading(confirmDeleteBtn, true);

            const response = await fetch(`/api/classes/${id}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                showToast(data.message || 'Class deleted successfully!', 'success');
                deleteModal.hide();
                loadClasses();
                loadStatistics();
            } else {
                showToast('Error: ' + (data.message || 'Failed to delete class'), 'error');
            }
        } catch (error) {
            console.error('Error deleting class:', error);
            showToast('Failed to delete class. Please try again.', 'error');
        } finally {
            showButtonLoading(confirmDeleteBtn, false);
            deleteClassId = null;
        }
    }

    async function loadClassForEdit(id) {
        try {
            const response = await fetch(`/api/classes/${id}`);
            const data = await response.json();

            if (response.ok && data.class) {
                const classData = data.class;

                // Populate form
                document.getElementById('classId').value = classData.id;
                document.getElementById('className').value = classData.name || '';
                document.getElementById('classDescription').value = classData.description || '';
                document.getElementById('startDate').value = classData.startDate || '';
                document.getElementById('endDate').value = classData.endDate || '';
                document.getElementById('maxStudents').value = classData.maxStudents || '';
                document.getElementById('teacherId').value = classData.teacher ? classData.teacher.id : '';

                currentEditingId = id;
                modalTitle.textContent = 'Edit Class';
                saveClassBtn.innerHTML = '<i class="fas fa-save me-1"></i> Update Class';

                classModal.show();
            } else {
                showToast('Error: ' + (data.message || 'Failed to load class data'), 'error');
            }
        } catch (error) {
            console.error('Error loading class for edit:', error);
            showToast('Failed to load class data. Please try again.', 'error');
        }
    }

    // UI Functions
    function renderClassesTable(classes) {
        if (!classes || classes.length === 0) {
            classesTableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">No classes found</p>
                    </td>
                </tr>
            `;
            return;
        }

        const rows = classes.map(classItem => {
            const currentStudents = classItem.students ? classItem.students.length : 0;
            const maxStudents = classItem.maxStudents || 'N/A';
            const hasAvailableSpots = classItem.maxStudents ? currentStudents < classItem.maxStudents : true;

            const statusBadge = hasAvailableSpots
                ? '<span class="badge bg-success status-badge">Available</span>'
                : '<span class="badge bg-warning status-badge">Full</span>';

            const teacherName = classItem.teacher ? classItem.teacher.name || 'N/A' : 'Not Assigned';

            return `
                <tr>
                    <td>
                        <strong>${escapeHtml(classItem.name || 'N/A')}</strong>
                    </td>
                    <td>
                        <span class="text-muted">${escapeHtml(classItem.description || 'No description')}</span>
                    </td>
                    <td>${formatDate(classItem.startDate)}</td>
                    <td>${formatDate(classItem.endDate)}</td>
                    <td>
                        <span class="badge bg-light text-dark">${escapeHtml(teacherName)}</span>
                    </td>
                    <td>
                        <span class="badge bg-info">${currentStudents}</span>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${maxStudents}</span>
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm btn-action"
                                onclick="loadClassForEdit(${classItem.id})"
                                title="Edit Class">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm btn-action"
                                onclick="confirmDelete(${classItem.id}, '${escapeHtml(classItem.name)}')"
                                title="Delete Class">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        classesTableBody.innerHTML = rows;
    }

    function confirmDelete(id, name) {
        deleteClassId = id;
        document.getElementById('deleteClassName').textContent = name;
        deleteModal.show();
    }

    function resetForm() {
        classForm.reset();
        currentEditingId = null;
        clearValidationErrors();
    }

    function validateForm() {
        let isValid = true;
        clearValidationErrors();

        const name = document.getElementById('className').value.trim();
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const maxStudents = document.getElementById('maxStudents').value;

        if (!name) {
            showFieldError('className', 'Class name is required');
            isValid = false;
        }

        if (!startDate) {
            showFieldError('startDate', 'Start date is required');
            isValid = false;
        }

        if (!endDate) {
            showFieldError('endDate', 'End date is required');
            isValid = false;
        }

        if (startDate && endDate && startDate > endDate) {
            showFieldError('endDate', 'End date must be after start date');
            isValid = false;
        }

        if (maxStudents && parseInt(maxStudents) < 1) {
            showFieldError('maxStudents', 'Maximum students must be at least 1');
            isValid = false;
        }

        return isValid;
    }

    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        field.classList.add('is-invalid');
        const feedback = field.parentNode.querySelector('.invalid-feedback');
        if (feedback) {
            feedback.textContent = message;
        }
    }

    function clearValidationErrors() {
        const invalidFields = document.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => {
            field.classList.remove('is-invalid');
        });
    }

    function showLoading(show) {
        const table = document.getElementById('classesTable');
        if (show) {
            table.classList.add('loading');
        } else {
            table.classList.remove('loading');
        }
    }

    function showButtonLoading(button, show) {
        if (show) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Saving...';
        } else {
            button.disabled = false;
            if (button.id === 'saveClassBtn') {
                const text = currentEditingId ? 'Update Class' : 'Save Class';
                button.innerHTML = `<i class="fas fa-save me-1"></i> ${text}`;
            } else if (button.id === 'confirmDeleteBtn') {
                button.innerHTML = '<i class="fas fa-trash me-1"></i> Delete Class';
            }
        }
    }

    function showToast(message, type = 'info') {
        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';

        const toastHtml = `
            <div class="toast ${bgClass} text-white" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header ${bgClass} text-white border-0">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    <strong class="me-auto">${type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Info'}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${escapeHtml(message)}
                </div>
            </div>
        `;

        document.getElementById('toastContainer').insertAdjacentHTML('beforeend', toastHtml);
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();

        // Remove toast element after it's hidden
        document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }

    // Utility Functions
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (error) {
            return 'Invalid Date';
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
</body>
</html>